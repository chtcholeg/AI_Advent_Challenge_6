# Изменения в day-02-structured-response по сравнению с day-01-simple-chat

## Краткое описание

Проект был расширен для поддержки структурированных JSON-ответов от AI. Добавлена возможность включения специального режима, в котором AI отвечает строго в формате JSON с определенной структурой, а также функциональность для парсинга и форматированного отображения этих ответов.

## Основные изменения

### 1. Модель данных

#### `AiSettings.kt`
- Добавлено поле `useStructuredResponse: Boolean` - включение/выключение режима структурированных ответов
- Добавлено поле `systemPrompt: String` - системный промпт для AI
- Добавлена константа `DEFAULT_SYSTEM_PROMPT` - детально описанный системный промпт, который инструктирует AI отвечать в строгом JSON формате

Системный промпт содержит:
- Критические правила для валидного JSON
- Точную структуру ответа с полями: `question_short`, `response`, `responder_role`, `unicode_symbols`
- Примеры корректного ответа

#### `ChatMessage.kt`
- Добавлен enum `MessageType` с типами: `USER`, `AI`, `SYSTEM`
- Добавлено поле `messageType: MessageType` для различения типов сообщений
- Системные сообщения теперь могут отображаться отдельно от пользовательских и AI сообщений

#### `StructuredResponse.kt` (новый файл)
- Data class для представления структурированного JSON ответа
- Метод `tryParse()` для безопасного парсинга JSON строки
- Метод `looksLikeStructuredResponse()` для проверки, является ли строка JSON ответом
- Поддержка удаления markdown code blocks перед парсингом
- Использует `kotlinx.serialization` для десериализации

### 2. UI компоненты

#### `ChatColors.kt`
- Добавлены цвета для системных сообщений:
  - `SystemBubbleBackground` - фон с прозрачностью
  - `SystemBubbleText` - текст темного цвета
  - `SystemBubbleTimestamp` - временная метка

#### `MessageItem.kt`
- Полностью переработан для поддержки трех типов сообщений
- Системные сообщения отображаются по центру с увеличенной шириной (90% вместо 75%)
- Системные сообщения имеют одинаковые скругленные углы (16.dp на всех углах)
- Пользовательские и AI сообщения имеют асимметричные углы (одна сторона 4.dp)
- Добавлен компонент `StructuredMessageContent` для отображения JSON ответов:
  - Кнопка переключения между JSON и форматированным видом
  - Форматированный вид показывает:
    - Unicode символы крупным шрифтом
    - "Вопрос коротко:" с кратким содержанием
    - "Ответ:" с детальным ответом
    - "Ответил на него:" с ролью эксперта
  - Автоматическое определение JSON ответов
  - Обработка ошибок парсинга

#### `SettingsScreen.kt`
- Добавлен компонент `StructuredResponseSwitch`:
  - Switch для включения/выключения режима структурированных ответов
  - Описание функции
  - Дополнительная информация при включении режима
  - Кастомные цвета для Switch
- Добавлен import для `FontStyle`

### 3. Бизнес-логика

#### `ChatRepositoryImpl.kt`
- Добавлено поле `currentSystemPrompt: String?` для отслеживания текущего промпта
- Логика автоматического управления системным промптом:
  - При включении структурированного режима добавляется системное сообщение в историю
  - При изменении промпта история очищается и добавляется новый промпт
  - При выключении режима история очищается от системных сообщений
- Системный промпт отправляется в API как первое сообщение с role="system"

#### `ChatStore.kt`
- Добавлен `SettingsRepository` в конструктор
- Добавлен `init` блок с подпиской на изменения настроек
- Добавлен метод `handleStructuredResponseChange()`:
  - Отслеживает включение/выключение режима
  - Добавляет информационное системное сообщение в UI при включении
  - Удаляет системные сообщения из UI при выключении
- Добавлено поле `currentUseStructuredResponse` для отслеживания состояния

#### `Koin.kt`
- Обновлен factory для `ChatStore` - добавлен параметр `settingsRepository`

### 4. Функциональность

#### Режим структурированных ответов:
1. Пользователь включает режим в настройках
2. В чат добавляется системное сообщение (отображается другим цветом по центру)
3. При следующем запросе в API отправляется системный промпт
4. AI отвечает в JSON формате
5. В MessageItem автоматически определяется JSON и добавляется кнопка форматирования
6. Пользователь может переключаться между JSON и форматированным видом

#### Отображение сообщений:
- **Пользовательские** (справа, темно-синий фон)
- **AI** (слева, серо-синий фон)
- **Системные** (по центру, прозрачный лиловый фон)

## Тестирование

Проект успешно собирается на всех основных платформах:
- ✅ Android (Debug и Release)
- ✅ Desktop (JVM)
- ✅ Web (WasmJS Development)
- ⚠️ Web (WasmJS Production) - минорная проблема с зависимостями задач Gradle (не критично)

## Технические детали

### Зависимости
- Использует существующие зависимости, новых не добавлено
- `kotlinx.serialization` для парсинга JSON

### Архитектурные решения
- MVI паттерн сохранен
- Реактивное управление состоянием через StateFlow
- Dependency Injection через Koin
- Multiplatform совместимость

### Безопасность
- Валидация JSON перед парсингом
- Обработка ошибок парсинга
- Очистка markdown code blocks из ответов AI

## Рекомендации по использованию

1. Включите "Structured JSON Response" в настройках
2. Задавайте вопросы AI
3. Используйте кнопку "Format" для просмотра красиво отформатированного ответа
4. Системный промпт можно отключить, и AI вернется к обычному режиму
