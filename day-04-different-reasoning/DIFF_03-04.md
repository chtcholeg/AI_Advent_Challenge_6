# Изменения между Day 03 и Day 04

## Обзор

Day 04 расширяет систему режимов ответа, добавляя два новых мощных подхода к reasoning: пошаговое решение задач и симуляцию панели экспертов.

## Новые функции

### 1. Step-by-Step Reasoning Mode (Пошаговое решение)

**Назначение:** AI решает задачи, разбивая их на логические шаги с объяснением на каждом этапе.

**Когда использовать:**
- Математические задачи
- Логические головоломки
- Аналитические вопросы
- Изучение сложных концепций
- Отладка и troubleshooting

**Формат ответа:**
```
**Understanding the Problem:**
[Переформулировка задачи]

**Given Information:**
- [Известные данные]

**Step-by-Step Solution:**

**Step 1: [Название шага]**
[Объяснение и работа]

**Step 2: [Название шага]**
[Объяснение и работа]

**Final Answer/Conclusion:**
[Итоговый ответ]
```

### 2. Expert Panel Discussion Mode (Панель экспертов)

**Назначение:** AI симулирует дискуссию 3-4 экспертов с разными точками зрения, которые обсуждают тему и формируют консенсус.

**Когда использовать:**
- Бизнес-решения
- Карьерные советы
- Технические архитектурные решения
- Темы, требующие разных точек зрения

**Формат ответа:**
```
**Panel Introduction:**
[Представление экспертов]

---

**Expert 1 - [Роль]:** "[Имя]"
[Позиция эксперта]

**Expert 2 - [Роль]:** "[Имя]"
[Другая точка зрения]

**Expert 3 - [Роль]:** "[Имя]"
[Третья перспектива]

---

**Panel Discussion Highlights:**
[Основные точки согласия и разногласий]

**Consensus Conclusion:**
[Общий вывод панели]
```

## Изменения в коде

### ResponseMode.kt

**Путь:** `composeApp/src/commonMain/kotlin/ru/chtcholeg/app/domain/model/ResponseMode.kt`

**Было (3 режима):**
```kotlin
enum class ResponseMode {
    NORMAL,
    STRUCTURED_JSON,
    DIALOG
}
```

**Стало (5 режимов):**
```kotlin
enum class ResponseMode {
    NORMAL,
    STRUCTURED_JSON,
    DIALOG,
    STEP_BY_STEP,      // NEW
    EXPERT_PANEL       // NEW
}
```

**Добавлено:**
```kotlin
STEP_BY_STEP(
    displayName = "Step-by-Step Reasoning",
    description = "AI solves problems by breaking them down into clear, logical steps"
),

EXPERT_PANEL(
    displayName = "Expert Panel Discussion",
    description = "AI simulates a panel of experts debating and forming a consensus on the topic"
)
```

**Обновлён `fromString()`:**
```kotlin
fun fromString(value: String?): ResponseMode {
    return when (value?.uppercase()) {
        "NORMAL" -> NORMAL
        "STRUCTURED_JSON", "JSON" -> STRUCTURED_JSON
        "DIALOG" -> DIALOG
        "STEP_BY_STEP", "STEP" -> STEP_BY_STEP      // NEW
        "EXPERT_PANEL", "EXPERT" -> EXPERT_PANEL    // NEW
        else -> DEFAULT
    }
}
```

---

### AiSettings.kt

**Путь:** `composeApp/src/commonMain/kotlin/ru/chtcholeg/app/domain/model/AiSettings.kt`

**Добавлены новые системные промпты:**

#### STEP_BY_STEP_SYSTEM_PROMPT
```kotlin
const val STEP_BY_STEP_SYSTEM_PROMPT = """You are an AI assistant that MUST solve every problem step-by-step using clear, logical reasoning.

YOUR PRIMARY ROLE:
Break down complex problems into manageable steps, showing your reasoning process explicitly at each stage.

CRITICAL RULES - YOU MUST FOLLOW THESE STRICTLY:
1. ALWAYS start by restating the problem in your own words
2. Identify what information is given and what needs to be found
3. Break the solution into numbered steps (Step 1, Step 2, etc.)
4. Explain your reasoning at EACH step
5. Show any calculations or derivations clearly
6. Provide a clear FINAL ANSWER or CONCLUSION
...
"""
```

#### EXPERT_PANEL_SYSTEM_PROMPT
```kotlin
const val EXPERT_PANEL_SYSTEM_PROMPT = """You are simulating a panel discussion among 3-4 diverse experts who analyze the user's question from different perspectives and then form a consensus.

YOUR PRIMARY ROLE:
Simulate a thoughtful discussion between experts with different viewpoints, eventually reaching a well-reasoned conclusion.

THE EXPERT PANEL:
For each question, select 3-4 relevant experts based on the topic...

CRITICAL RULES:
1. Each expert MUST have a distinct personality and viewpoint
2. Experts should BUILD on or CHALLENGE each other's points
3. Include realistic disagreements but work toward synthesis
...
"""
```

---

### ChatRepositoryImpl.kt

**Путь:** `composeApp/src/commonMain/kotlin/ru/chtcholeg/app/data/repository/ChatRepositoryImpl.kt`

**Было:**
```kotlin
val systemPrompt = when (settings.responseMode) {
    ResponseMode.DIALOG -> AiSettings.DIALOG_SYSTEM_PROMPT
    ResponseMode.STRUCTURED_JSON -> settings.systemPrompt
    ResponseMode.NORMAL -> null
}
```

**Стало:**
```kotlin
val systemPrompt = when (settings.responseMode) {
    ResponseMode.DIALOG -> AiSettings.DIALOG_SYSTEM_PROMPT
    ResponseMode.STRUCTURED_JSON -> settings.systemPrompt
    ResponseMode.STEP_BY_STEP -> AiSettings.STEP_BY_STEP_SYSTEM_PROMPT    // NEW
    ResponseMode.EXPERT_PANEL -> AiSettings.EXPERT_PANEL_SYSTEM_PROMPT    // NEW
    ResponseMode.NORMAL -> null
}
```

---

### ChatStore.kt

**Путь:** `composeApp/src/commonMain/kotlin/ru/chtcholeg/app/presentation/chat/ChatStore.kt`

**Добавлены системные сообщения для новых режимов:**

```kotlin
ResponseMode.STEP_BY_STEP -> {
    val systemMessage = ChatMessage(
        content = "Step-by-Step reasoning mode enabled. AI will solve problems by breaking them down into clear, logical steps.",
        isFromUser = false,
        messageType = MessageType.SYSTEM
    )
    _state.update {
        it.copy(messages = it.messages.filter { msg -> msg.messageType != MessageType.SYSTEM } + systemMessage)
    }
}

ResponseMode.EXPERT_PANEL -> {
    val systemMessage = ChatMessage(
        content = "Expert Panel mode enabled. AI will simulate a panel of experts discussing the topic from different perspectives.",
        isFromUser = false,
        messageType = MessageType.SYSTEM
    )
    _state.update {
        it.copy(messages = it.messages.filter { msg -> msg.messageType != MessageType.SYSTEM } + systemMessage)
    }
}
```

---

### SettingsScreen.kt

**Путь:** `composeApp/src/commonMain/kotlin/ru/chtcholeg/app/presentation/settings/SettingsScreen.kt`

**Добавлены описания для новых режимов в `ResponseModeSelector`:**

```kotlin
Text(
    text = when (currentMode) {
        ResponseMode.NORMAL -> "AI will respond directly to your questions..."
        ResponseMode.STRUCTURED_JSON -> "AI will respond in strict JSON format..."
        ResponseMode.DIALOG -> "AI will ask clarifying questions one at a time..."
        ResponseMode.STEP_BY_STEP -> "AI will solve problems step-by-step, showing clear reasoning at each stage. Ideal for math, logic, and analytical questions."    // NEW
        ResponseMode.EXPERT_PANEL -> "AI simulates a panel of 3-4 experts discussing the topic from different perspectives, then forming a consensus conclusion."    // NEW
    },
    ...
)
```

---

## Обновления документации

| Файл | Изменения |
|------|-----------|
| `README.md` | Обновлён заголовок на Day 4, добавлены описания новых режимов в Features и Response Mode Details |
| `CLAUDE.md` | Добавлено описание новых фич day-04, обновлён ResponseMode enum |
| `AI_SETTINGS.md` | Переработан раздел Response Mode, добавлены описания Step-by-Step и Expert Panel |
| `DIALOG_MODE.md` | Обновлены примеры кода с 5 режимами вместо 3 |
| `DIFFERENT_REASONING.md` | **НОВЫЙ ФАЙЛ** - подробная документация по новым режимам reasoning |
| `DIFF_02-03.md` | **УДАЛЁН** - заменён на DIFF_03-04.md |

---

## Сравнение режимов (Day 04)

| Режим | Назначение | Стиль вывода |
|-------|------------|--------------|
| Normal | Обычный разговор | Естественный, разговорный |
| Structured JSON | Извлечение данных | JSON с метаданными |
| Dialog | Сбор требований | По одному вопросу за раз |
| **Step-by-Step** | Решение задач | Пронумерованные шаги с reasoning |
| **Expert Panel** | Принятие решений | Многоперспективная дискуссия |

---

## Архитектурные особенности

### Расширяемость
Добавление новых режимов требует изменений в 4 файлах:
1. `ResponseMode.kt` - новое значение enum
2. `AiSettings.kt` - системный промпт
3. `ChatRepositoryImpl.kt` - маппинг режима на промпт
4. `ChatStore.kt` - системное сообщение в UI
5. `SettingsScreen.kt` - описание режима

### Взаимоисключаемость
Все 5 режимов остаются взаимоисключающими через dropdown selector. При переключении режима:
- Очищается предыдущий системный промпт
- Добавляется новое системное сообщение в чат
- Контекст AI перенастраивается на выбранный режим

---

## Как тестировать

### Step-by-Step Mode
```
Вопрос: "Если поезд едет 120 км за 2 часа, сколько времени нужно на 300 км?"
Ожидание: Пошаговое решение с расчётом скорости и времени
```

### Expert Panel Mode
```
Вопрос: "Стоит ли учить Python или JavaScript первым?"
Ожидание: 3-4 эксперта с разными мнениями и консенсус в конце
```

---

## Команды сборки

```bash
# Компиляция Desktop
./gradlew :composeApp:compileKotlinDesktop

# Компиляция Android
./gradlew :composeApp:compileDebugKotlinAndroid

# Запуск Desktop
./gradlew :composeApp:runDesktop

# Запуск Android
./gradlew :composeApp:installDebug
```
