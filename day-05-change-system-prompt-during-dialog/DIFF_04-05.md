# Differences Between Day 4 and Day 5

This document describes the changes made from day-04-different-reasoning to day-05-change-system-prompt-during-dialog.

## New Features

### 1. Preserve Chat History on System Prompt Change

A new setting that allows users to choose whether chat history should be preserved or cleared when changing response modes.

**Behavior:**
- **OFF (default)**: When switching response modes, the chat history is cleared (original behavior)
- **ON**: When switching response modes, chat history is preserved, only the system prompt is updated

**Use Cases:**
- Continue a conversation with a different AI reasoning approach
- Experiment with different response modes without losing context
- Keep conversation history while changing AI behavior

### 2. Structured XML Response Mode

A new response mode that provides AI responses in strict XML format, similar to the existing JSON mode.

**XML Structure:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<response>
  <question_short>Brief summary of the question</question_short>
  <answer>Detailed answer to the question</answer>
  <responder_role>Expert role (e.g., Chef, Engineer)</responder_role>
  <unicode_symbols>Relevant emoji symbols</unicode_symbols>
</response>
```

### 3. Fixed Dropdown Menu Text Color

The text in Response Mode and Model dropdown menus now uses a dark color for better visibility against the light background.

## File Changes

### Modified Files

#### 1. `domain/model/ResponseMode.kt`
- Added `STRUCTURED_XML` enum value with displayName and description
- Updated `fromString()` to handle "STRUCTURED_XML" and "XML" identifiers

#### 2. `domain/model/AiSettings.kt`
- Added `preserveHistoryOnSystemPromptChange: Boolean` field (default: `false`)
- Added `DEFAULT_PRESERVE_HISTORY` constant
- Added `STRUCTURED_XML_SYSTEM_PROMPT` constant with XML formatting instructions

#### 3. `data/repository/ChatRepositoryImpl.kt`
- Added `ResponseMode.STRUCTURED_XML` case in system prompt selection
- Updated system prompt change logic to respect `preserveHistoryOnSystemPromptChange` setting
- When preserving history: replaces/adds system message without clearing conversation
- When not preserving history: clears all history (original behavior)

#### 4. `presentation/chat/ChatStore.kt`
- Added handling for `ResponseMode.STRUCTURED_XML` in `handleResponseModeChange()`
- Updated mode change logic to check `preserveHistoryOnSystemPromptChange` setting
- When enabled: preserves messages and updates only system message
- When disabled: clears repository history and UI state

#### 5. `presentation/settings/SettingsScreen.kt`
- Added `PreserveHistorySetting` composable with Switch toggle
- Added UI element below Response Mode selector
- Changed dropdown menu text color from `ChatColors.UserBubbleText` (light) to `ChatColors.HeaderBackground` (dark) for better visibility
- Added XML mode description in response mode selector

### Documentation Updates

#### README.md
- Updated title to "Day 5 - Preserve History on System Prompt Change"
- Added new features section describing Preserve History and XML mode
- Updated features list with new functionality
- Added "Preserve Chat History Setting" configuration section
- Added "Structured XML Response Mode" description with example

#### CLAUDE.md
- Added day-05 feature description
- Updated ResponseMode enum documentation
- Updated AiSettings documentation with new fields

### Deleted Files

#### DIFF_03-04.md
- Removed as it's no longer relevant for day-05

### Created Files

#### DIFF_04-05.md
- This file documenting changes between day-04 and day-05

## Summary

Day 5 introduces two main features:
1. **Preserve History Setting** - Allows users to keep conversation context when switching between AI response modes
2. **XML Response Mode** - Provides structured XML output as an alternative to JSON

Additionally, the UI was improved by fixing dropdown menu text visibility.

Total response modes now available: 6 (Normal, JSON, XML, Dialog, Step-by-Step, Expert Panel)
