# Различия между Day 6 и Day 7

## Краткое описание

Day 7 добавляет отображение метаданных для ответов от AI, расширяет список доступных моделей (GigaChat Pro/Max + 5 моделей Hugging Face), улучшает цветовую схему dropdown меню и удаляет поддержку Web платформы (оставлены только Android и Desktop).

## Новые возможности

### 1. Отображение времени выполнения запроса
- Каждое сообщение от AI теперь показывает, сколько времени занял запрос к API
- Формат адаптируется под длительность:
  - Миллисекунды для быстрых ответов: "342ms"
  - Секунды для типичных ответов: "2.1s"
  - Минуты + секунды для долгих ответов: "1m 15s"

### 2. Отображение количества токенов
- Показывается общее количество использованных токенов
- Детализированная разбивка: prompt tokens + completion tokens
- Формат: "156 tokens (42+114)"
  - 42 = токены запроса (вопрос + контекст)
  - 114 = токены ответа (сгенерированный текст)

### 3. Преимущества метаданных
- **Анализ производительности**: сравнение времени ответа разных моделей
- **Контроль расходов**: отслеживание использования токенов для биллинга API
- **Отладка**: понимание почему некоторые ответы занимают больше времени
- **Оптимизация**: информация для настройки max_tokens и упрощения промптов

### 4. Расширенный список AI моделей

**GigaChat (Sberbank):**
- GigaChat (базовая) - без изменений
- **GigaChat Pro** - улучшенная версия с балансом качества и производительности
- **GigaChat Max** - самая мощная модель, #1 в MERA бенчмарке для русского языка

**Hugging Face (5 моделей разных временных периодов):**
- **Mistral 7B Instruct v0.1** (Сентябрь 2023) - первая открытая модель Mistral AI, превзошедшая Llama 2 13B
- **Gemma 2 9B IT** (Июнь 2024) - Google, отличный баланс размера и качества
- **Llama 3.2 3B Instruct** (Сентябрь 2024) - Meta, компактная модель для edge/mobile
- **DeepSeek R1** (Январь 2025) - специализация на reasoning и chain-of-thought
- **Qwen3 8B** (Апрель 2025) - Alibaba, поддержка 119 языков, Thinking/Non-Thinking режимы

### 5. Улучшенная цветовая схема dropdown меню
- Добавлены контрастные цвета для текста в dropdown меню
- Новые цвета в ChatColors: DropdownBackground, DropdownText, DropdownTextSecondary
- Улучшена читаемость выбора модели и режима ответа

### 6. Удаление Web платформы
- Удалена поддержка WasmJs (Web) платформы
- Оставлены только Android и Desktop (JVM)
- Упрощена сборка и уменьшен размер проекта
- Удалены файлы: wasmJsMain/, wasm-related Gradle tasks

## Технические изменения

### Новые файлы

1. **AiResponse.kt** (`domain/model/`)
   - Новый data class для возврата ответа с метаданными
   - Поля: content, executionTimeMs, promptTokens, completionTokens, totalTokens
   - Используется как возвращаемый тип из repository и use case

2. **MODELS.md** (корень проекта)
   - Документация по всем AI моделям в приложении
   - Описание, даты выхода, разработчики, особенности
   - Хронологическая таблица и рекомендации по выбору

### Удалённые файлы и директории

1. **wasmJsMain/** - полностью удалена директория Web платформы
   - ClipboardManager.wasmJs.kt
   - main.kt (Web entry point)
   - resources/index.html

### Измененные файлы

1. **ChatMessage.kt** (`domain/model/`)
   - Добавлены новые nullable поля:
     - `executionTimeMs: Long?` - время выполнения в миллисекундах
     - `promptTokens: Int?` - токены запроса
     - `completionTokens: Int?` - токены ответа
     - `totalTokens: Int?` - общее количество токенов

2. **ChatRepository.kt** (`data/repository/`)
   - Изменен тип возвращаемого значения метода `sendMessage()`
   - Было: `suspend fun sendMessage(userMessage: String): String`
   - Стало: `suspend fun sendMessage(userMessage: String): AiResponse`

3. **ChatRepositoryImpl.kt** (`data/repository/`)
   - Импортирован `AiResponse` и `kotlin.time.measureTimedValue`
   - API вызов обёрнут в `measureTimedValue { }` для замера времени
   - Формирование `AiResponse` с данными из `ChatResponse.usage`
   - Возвращается объект с контентом, временем и токенами

4. **SendMessageUseCase.kt** (`domain/usecase/`)
   - Изменен тип возвращаемого значения
   - Было: `suspend operator fun invoke(message: String): String`
   - Стало: `suspend operator fun invoke(message: String): AiResponse`

5. **ChatStore.kt** (`presentation/chat/`)
   - Обновлено создание `ChatMessage` при получении ответа
   - Поля `executionTimeMs`, `promptTokens`, `completionTokens`, `totalTokens` заполняются из `AiResponse`

6. **MessageItem.kt** (`presentation/components/`)
   - Добавлен блок отображения метаданных для AI сообщений
   - Показывается над временной меткой
   - Добавлена функция `formatExecutionTime(milliseconds: Long)`
   - Условное отображение: только если есть данные (executionTimeMs или totalTokens)

7. **Model.kt** (`domain/model/`)
   - Добавлены модели: GigaChatPro, GigaChatMax
   - Добавлены модели Hugging Face: Mistral7BInstruct, Gemma29BIt, Llama323BInstruct, DeepSeekR1, Qwen3_8B
   - Удалены устаревшие модели: Llama3_8B, Llama3_1_8B, DeepSeek

8. **ChatColors.kt** (`presentation/theme/`)
   - Добавлены цвета: DropdownBackground, DropdownText, DropdownTextSecondary
   - Контрастные цвета для текста в dropdown меню

9. **SettingsScreen.kt** (`presentation/settings/`)
   - ModelSelector и ResponseModeSelector используют новые цвета
   - Улучшена читаемость dropdown меню

10. **build.gradle.kts** (`composeApp/`)
    - Удалён wasmJs target
    - Удалён wasmJsMain sourceset
    - Удалены wasm-related tasks (copyWasmIndexHtml, copyWasmIndexHtmlProduction)
    - Удалён импорт ExperimentalWasmDsl

11. **README.md** и **CLAUDE.md**
    - Удалены все упоминания Web платформы
    - Обновлены команды сборки (удалены wasmJs команды)
    - Обновлена документация архитектуры

## Архитектурные решения

### Новый доменный класс AiResponse
- Отделяет данные ответа от UI-модели ChatMessage
- Содержит только релевантные для ответа данные
- Позволяет расширять метаданные в будущем без изменения ChatMessage

### Использование kotlin.time
- `measureTimedValue` из стандартной библиотеки Kotlin
- Кросс-платформенное решение (работает на всех targets)
- Точное измерение времени выполнения

### Nullable поля в ChatMessage
- Метаданные опциональны (nullable)
- Пользовательские сообщения не имеют метаданных
- API может не возвращать usage (зависит от провайдера)

### UI отображение
- Метаданные показываются только для AI сообщений
- Компактный формат: "2.1s | 156 tokens (42+114)"
- Разделитель "|" только если есть оба значения
- Цвет соответствует timestamp для консистентности

## Изменения в потоке данных

```
До (Day 6):
Repository.sendMessage() -> String -> ChatStore -> ChatMessage(content)

После (Day 7):
Repository.sendMessage() -> AiResponse(content, time, tokens)
  -> ChatStore -> ChatMessage(content, executionTimeMs, tokens...)
```

## Зависимости

Новые импорты:
- `kotlin.time.measureTimedValue` - для замера времени
- `ru.chtcholeg.app.domain.model.AiResponse` - новый доменный класс

## Совместимость

- Все изменения обратно совместимы
- Существующие сообщения без метаданных отображаются корректно
- UI адаптируется к наличию/отсутствию данных
- API, не возвращающие usage, работают без ошибок (показывается только время)
