# Различия между Day 6 и Day 7

## Краткое описание

Day 7 добавляет отображение метаданных для ответов от AI: время выполнения запроса и количество использованных токенов. Это позволяет пользователям анализировать производительность и отслеживать использование API.

## Новые возможности

### 1. Отображение времени выполнения запроса
- Каждое сообщение от AI теперь показывает, сколько времени занял запрос к API
- Формат адаптируется под длительность:
  - Миллисекунды для быстрых ответов: "342ms"
  - Секунды для типичных ответов: "2.1s"
  - Минуты + секунды для долгих ответов: "1m 15s"

### 2. Отображение количества токенов
- Показывается общее количество использованных токенов
- Детализированная разбивка: prompt tokens + completion tokens
- Формат: "156 tokens (42+114)"
  - 42 = токены запроса (вопрос + контекст)
  - 114 = токены ответа (сгенерированный текст)

### 3. Преимущества
- **Анализ производительности**: сравнение времени ответа разных моделей
- **Контроль расходов**: отслеживание использования токенов для биллинга API
- **Отладка**: понимание почему некоторые ответы занимают больше времени
- **Оптимизация**: информация для настройки max_tokens и упрощения промптов

## Технические изменения

### Новые файлы

1. **AiResponse.kt** (`domain/model/`)
   - Новый data class для возврата ответа с метаданными
   - Поля: content, executionTimeMs, promptTokens, completionTokens, totalTokens
   - Используется как возвращаемый тип из repository и use case

### Измененные файлы

1. **ChatMessage.kt** (`domain/model/`)
   - Добавлены новые nullable поля:
     - `executionTimeMs: Long?` - время выполнения в миллисекундах
     - `promptTokens: Int?` - токены запроса
     - `completionTokens: Int?` - токены ответа
     - `totalTokens: Int?` - общее количество токенов

2. **ChatRepository.kt** (`data/repository/`)
   - Изменен тип возвращаемого значения метода `sendMessage()`
   - Было: `suspend fun sendMessage(userMessage: String): String`
   - Стало: `suspend fun sendMessage(userMessage: String): AiResponse`

3. **ChatRepositoryImpl.kt** (`data/repository/`)
   - Импортирован `AiResponse` и `kotlin.time.measureTimedValue`
   - API вызов обёрнут в `measureTimedValue { }` для замера времени
   - Формирование `AiResponse` с данными из `ChatResponse.usage`
   - Возвращается объект с контентом, временем и токенами

4. **SendMessageUseCase.kt** (`domain/usecase/`)
   - Изменен тип возвращаемого значения
   - Было: `suspend operator fun invoke(message: String): String`
   - Стало: `suspend operator fun invoke(message: String): AiResponse`

5. **ChatStore.kt** (`presentation/chat/`)
   - Обновлено создание `ChatMessage` при получении ответа
   - Поля `executionTimeMs`, `promptTokens`, `completionTokens`, `totalTokens` заполняются из `AiResponse`

6. **MessageItem.kt** (`presentation/components/`)
   - Добавлен блок отображения метаданных для AI сообщений
   - Показывается над временной меткой
   - Добавлена функция `formatExecutionTime(milliseconds: Long)`
   - Условное отображение: только если есть данные (executionTimeMs или totalTokens)

## Архитектурные решения

### Новый доменный класс AiResponse
- Отделяет данные ответа от UI-модели ChatMessage
- Содержит только релевантные для ответа данные
- Позволяет расширять метаданные в будущем без изменения ChatMessage

### Использование kotlin.time
- `measureTimedValue` из стандартной библиотеки Kotlin
- Кросс-платформенное решение (работает на всех targets)
- Точное измерение времени выполнения

### Nullable поля в ChatMessage
- Метаданные опциональны (nullable)
- Пользовательские сообщения не имеют метаданных
- API может не возвращать usage (зависит от провайдера)

### UI отображение
- Метаданные показываются только для AI сообщений
- Компактный формат: "2.1s | 156 tokens (42+114)"
- Разделитель "|" только если есть оба значения
- Цвет соответствует timestamp для консистентности

## Изменения в потоке данных

```
До (Day 6):
Repository.sendMessage() -> String -> ChatStore -> ChatMessage(content)

После (Day 7):
Repository.sendMessage() -> AiResponse(content, time, tokens)
  -> ChatStore -> ChatMessage(content, executionTimeMs, tokens...)
```

## Зависимости

Новые импорты:
- `kotlin.time.measureTimedValue` - для замера времени
- `ru.chtcholeg.app.domain.model.AiResponse` - новый доменный класс

## Совместимость

- Все изменения обратно совместимы
- Существующие сообщения без метаданных отображаются корректно
- UI адаптируется к наличию/отсутствию данных
- API, не возвращающие usage, работают без ошибок (показывается только время)
